<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Watch List</title>
    <style>
        /* Минимальные стили */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f9; }
        header { background: #4CAF50; color: #fff; padding: 1rem; text-align: center; }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; background: #fff; border-radius: 5px; }
        .list { margin-bottom: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 5px; }
        .item {
            display: flex;
            align-items: center; /* ✅ Выравниваем элементы по вертикали */
            gap: 15px; /* ✅ Добавляем отступ между картинкой и текстом */
            padding: 10px;
            border: 2px solid #4CAF50; /* ✅ Рамка зелёного цвета */
            border-radius: 10px; /* ✅ Скругляем углы */
            background: #fff; /* ✅ Белый фон */
            margin-bottom: 10px; /* ✅ Отступ между элементами */
            max-width: 500px; /* ✅ Ограничиваем ширину */
        }

        .item img {
            width: 80px; /* ✅ Уменьшаем картинку */
            height: auto;
            border-radius: 5px; /* ✅ Немного скругляем углы */
        }

        .item-content {
            display: flex;
            flex-direction: column;
            justify-content: center; /* ✅ Выравниваем текст по центру */
        }

        .item-buttons {
            display: flex;
            gap: 5px; /* ✅ Добавляем отступы между кнопками */
        }

        button {
            padding: 5px 10px;
            border: none;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            border-radius: 5px;
        }
        .item.watched {
            background: #dff0d8; /* ✅ Светло-зелёный фон */
            opacity: 0.7; /* ✅ Делаем полупрозрачным */
        }

        button:hover {
            background: #388E3C;
        }
        .back-button {
            background: none;
            border: none;
            font-size: 18px;
            color: #4CAF50;
            cursor: pointer;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .back-button {
            background: none;
            border: none;
            cursor: pointer;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-icon {
            width: 30px;  /* ✅ Размер стрелки */
            height: auto;
            transition: transform 0.2s ease-in-out;
        }

        .back-button:hover .back-icon {
            transform: scale(1.1); /* ✅ Эффект при наведении */
        }

        .list-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px; /* ✅ Отступ от списка */
            padding: 10px;
            border-bottom: 2px solid #4CAF50; /* ✅ Разделительная линия */
        }

        #share-list-button {
            background: #4CAF50;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #share-list-button:hover {
            background: #388E3C;
        }
        .shared-list {
            background: #f1f8e9; /* Светло-зелёный фон */
            border-left: 4px solid #4CAF50; /* Зеленая полоса слева */
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .shared-list h3 {
            font-size: 16px;
            margin: 0;
        }

        .shared-list small {
            color: #388E3C;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <header>
        <h1>To-Watch List</h1>
    </header>
    <div class="container" id="app">
        <div id="auth-section">
            <h2>Login/Register</h2>
            <form id="login-form">
                <input type="text" id="username" placeholder="Username" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit">Login/Register</button>
            </form>
        </div>
        <div id="lists-section" style="display: none;">
            <h2>Your Lists</h2>
            <div id="lists-container"></div> <!-- Личные списки -->
            <button id="create-list-button">Create New List</button>
            <div id="shared-lists-section">
                <h2>Shared with You</h2>
                <div id="shared-lists-container"></div>
            </div>
            <button id="logout-button" style="margin-top: 10px; background: red;">Logout</button>
        </div>
        <div id="items-section" style="display: none;">
            <div class="list-header">
                <button id="back-to-lists" class="back-button">
                    <img src="images/left.png" alt="Back" class="back-icon">
                </button>
                <h2 id="current-list-name"></h2>
                <button id="share-list-button">Share List</button>
            </div>
            <div id="items-container"></div>
            </div>
    </div>
    <script>
        const apiUrl = 'https://192.168.0.9:3367';
		
		const kinopoiskApiKey = 'BPAY6H3-NKPM59S-PJ2R7B0-SK74YCX';
        const searchContainer = document.createElement('div');
        const input = document.createElement('input');
        input.placeholder = 'Найти фильм...';
        const searchButton = document.createElement('button');
        searchButton.textContent = 'Поиск';
        const resultsList = document.createElement('ul');
        resultsList.id = 'kinopoisk-results';

        searchButton.onclick = async () => {
            const query = input.value.trim();
            if (!query) return;

            const res = await fetch(`https://api.kinopoisk.dev/v1.4/movie/search?query=${encodeURIComponent(query)}`, {
                headers: { 'X-API-KEY': kinopoiskApiKey }
            });

            const data = await res.json();
            resultsList.innerHTML = '';
            data.docs.forEach(doc => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="item">
                      <img src="${doc.poster?.previewUrl || ''}" alt="poster" />
                      <div class="item-content">
                        <strong>${doc.name}</strong>
                        <span>${doc.year || ''} ${doc.genres.map(g => g.name).join(', ')}</span>
                        <p>${doc.shortDescription || ''}</p>
                        <button class="add-button">Добавить</button>
                      </div>
                    </div>`;
                li.querySelector('.add-button').onclick = () => addFromKinopoisk(doc);
                resultsList.appendChild(li);
            });
        };

        function addFromKinopoisk(doc) {
            const listId = currentListId;
            const token = localStorage.getItem("token");
            fetch(`/items`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                list_id: listId,
                title: doc.name,
                type: doc.type || 'movie',
                genre: doc.genres.map(g => g.name).join(', '),
                cover_url: doc.poster?.url || ''
                })
            }).then(res => {
                if (res.ok) {
                    alert('Фильм добавлен!');
                    fetchItems(listId);
                    input.value = '';
                    resultsList.innerHTML = '';
                } else {
                    alert('Ошибка при добавлении.');
                }
            });
        }

        searchContainer.appendChild(input);
        searchContainer.appendChild(searchButton);
        searchContainer.appendChild(resultsList);
        document.getElementById('items-section').appendChild(searchContainer);

        searchContainer.appendChild(input);
        searchContainer.appendChild(searchButton);
        searchContainer.appendChild(resultsList);
        document.getElementById('items-section').appendChild(searchContainer);

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) {
                alert("Please enter username and password!");
                return;
            }

            console.log(username)
            console.log(`/user?username=${username}`)
            // Проверяем, существует ли пользователь
            let userCheck = await fetch(`/user?username=${username}`);
            let userData = await userCheck.json();

            if (userCheck.ok) {
            	console.log('Here')
                // Пользователь найден → выполняем ЛОГИН
                let loginResponse = await fetch(`/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                });

                if (loginResponse.ok) {
                    let result = await loginResponse.json();

                    if (result.token && result.user_id) {
                        localStorage.setItem("token", result.token);
                        localStorage.setItem("user_id", result.user_id);
                        document.getElementById('auth-section').style.display = 'none';
                        document.getElementById('lists-section').style.display = 'block'
                        fetchLists();
                    }
                } else {
                    alert("Incorrect password!");
                }
            } else {
            	console.log('Here1')
                // Пользователь НЕ найден → выполняем РЕГИСТРАЦИЮ
                let registerResponse = await fetch(`/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                });

                if (registerResponse.ok) {
                    localStorage.setItem("token", registerResponse.token);
                    localStorage.setItem("user_id", registerResponse.user_id);
                    document.getElementById('auth-section').classList.add('hidden');
                    document.getElementById('lists-section').classList.remove('hidden');
                    fetchLists();
                } else {
                    alert("Registration failed! Username might already exist.");
                }
            }
        });

        document.getElementById('back-to-lists').addEventListener('click', () => {
            document.getElementById('items-section').style.display = 'none';  // ❌ Скрываем элементы
            document.getElementById('lists-section').style.display = 'block'; // ✅ Показываем списки
        });

        document.getElementById('share-list-button').addEventListener('click', async () => {
            const listId = document.getElementById('share-list-button').getAttribute('data-list-id');
            if (!listId) {
                alert("Error: No list selected.");
                return;
            }

            const username = prompt("Enter username to share this list with:");
            if (!username) return;

            const token = localStorage.getItem("token");

            const response = await fetch(`/share`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ list_id: listId, username })
            });

            if (response.ok) {
                alert(`List shared with ${username}!`);
            } else {
                alert("Failed to share the list.");
            }
        });

        async function fetchSharedLists() {
            const token = localStorage.getItem("token");
            const section = document.getElementById('shared-lists-section'); // ✅ Берём всю секцию

            const res = await fetch(`/shared_lists`, {
                method: 'GET',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!res.ok) {
                alert("Failed to load shared lists.");
                return;
            }

            const sharedLists = await res.json();
            const container = document.getElementById('shared-lists-container');
            container.innerHTML = '';

            if (sharedLists.length === 0) {
                section.style.display = 'none';  // ❌ Скрываем секцию
                return;
            } else {
                section.style.display = 'block'; // ✅ Показываем секцию
            }

            sharedLists.forEach(list => {
                const div = document.createElement('div');
                div.className = 'list-item shared-list';
                div.innerHTML = `
                    <h3>${list.name} <small>(Shared by ${list.owner})</small></h3>
                    <button onclick="openList(${list.id}, '${list.name}')">Open</button>
                `;
                container.appendChild(div);
            });
        }


        document.getElementById('logout-button').addEventListener('click', () => {
            localStorage.removeItem("token");  // Удаляем JWT
            window.location.reload();  // Перезагружаем страницу
        });

        document.getElementById('create-list-button').addEventListener('click', async () => {
            const listName = prompt('Enter the name of the new list:');
            if (!listName) return;

            const token = localStorage.getItem("token");

            const response = await fetch(`/lists`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`},
                
                body: JSON.stringify({ user_id: 1, name: listName }), // Заменить user_id на актуальный
            });

            if (response.ok) {
                alert('List created successfully!');
                fetchLists(); // Обновляем списки после создания
            } else {
                alert('Failed to create list.');
            }
        });

        async function fetchItems(listId) {
            const token = localStorage.getItem("token");

            const res = await fetch(`/items?list_id=${listId}`, {
                method: 'GET',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!res.ok) {
                alert("Failed to load items.");
                return;
            }

            const items = await res.json();
            const container = document.getElementById('items-container');
            container.innerHTML = '';

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = `item ${item.watched ? 'watched' : ''}`;
                div.innerHTML = `
                    <img src="${item.cover_url || 'placeholder.jpg'}" alt="${item.title}">
                    <div class="item-content">
                        <strong>${item.title} (${item.type})</strong>
                        ${item.genre ? `<div>Жанр: ${item.genre}</div>` : ''}
						<div class="full-description" style="display: none;"></div>
                        <div class="item-buttons">
                            <button class="more-btn" onclick="showMoreInfo('${item.title}')">Подробнее</button>
                            <button onclick="toggleWatched(${item.id}, ${!item.watched})">
                                ${item.watched ? 'Unwatch' : 'Watched'}
                            </button>
                            <button onclick="deleteItem(${item.id})">Delete</button>
                        </div>
                    </div>`
               ;
                container.appendChild(div);
            });
        }
		
		async function showMoreInfo(title) {
		  
			const allItems = document.querySelectorAll('.item');
			
			foundItem = null
			
			allItems.forEach(item => {
				const label = item.querySelector('strong');
				if (label && label.textContent.includes(title)) {
					foundItem = item
					return
				}
			});
				
			if(!foundItem)
				return
			
			const descBlock = foundItem.querySelector('.full-description');
			const moreBtn = foundItem.querySelector('.item-buttons button');				
			
			if (descBlock.style.display === 'block') {
			  descBlock.style.display = 'none';
			  moreBtn.textContent = 'Подробнее';
			} else {
				const res = await fetch(`https://api.kinopoisk.dev/v1.4/movie/search?query=${encodeURIComponent(title)}`, {
					headers: { 'X-API-KEY': kinopoiskApiKey }
				  });
				const data = await res.json();
				if(data.docs.length < 0)
					return
				
				const info = data.docs[0];
				descBlock.innerHTML = `<p>${info.description || 'Нет описания'}</p>`;
				descBlock.style.display = 'block';
				moreBtn.textContent = 'Скрыть';
			}
		}

        async function deleteItem(itemId) {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("Session expired! Please log in again.");
                window.location.reload();
                return;
            }

            // ✅ Проверяем авторизацию перед удалением
            const authCheck = await fetch(`/auth-check`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!authCheck.ok) {
                alert("Session expired! Please log in again.");
                localStorage.removeItem("token");
                window.location.reload();
                return;
            }

            if (!confirm("Are you sure you want to delete this item?")) return;

            const response = await fetch(`/items`, {
                method: 'DELETE',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ id: itemId })
            });

            if (response.ok) {
                fetchItems(currentListId); // ߔ䠐новляем список
            } else {
                alert("Failed to delete item.");
            }
        }

        async function toggleWatched(itemId, watched) {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("Session expired! Please log in again.");
                window.location.reload();
                return;
            }

            // ✅ Проверяем авторизацию перед удалением
            const authCheck = await fetch(`/auth-check`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!authCheck.ok) {
                alert("Session expired! Please log in again.");
                localStorage.removeItem("token");
                window.location.reload();
                return;
            }

            const response = await fetch(`/items`, {
                method: 'PATCH',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ id: itemId, watched })
            });

            if (response.ok) {
                fetchItems(document.getElementById('add-item-button').getAttribute('data-list-id')); // ߔ䠐новляем список
            } else {
                alert("Failed to update watch status.");
            }
        }
        
        async function fetchLists() {
            const token = localStorage.getItem("token");

            const resAuth = await fetch(`/lists`, {
                method: 'GET',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`  // ߔ堐редаём JWT
                }
            });
            
            if (!resAuth.ok) {
                alert("Session expired! Please log in again.");
                localStorage.removeItem("token");  // Чистим токен при ошибке
                window.location.reload();  // Перезагружаем страницу
                return;
            }
            
            const lists = await resAuth.json();
            const container = document.getElementById('lists-container');
            container.innerHTML = '';

            lists.forEach(list => {
                const div = document.createElement('div');
                div.className = 'list';
                div.innerHTML = `
                    <h3>${list.name}</h3>
                    <button onclick="openList(${list.id}, '${list.name}')">Open</button>
                    <button onclick="renameList(${list.id}, '${list.name}')">Rename</button>
                    <button onclick="deleteList(${list.id})">Delete</button>`;                    
                container.appendChild(div);
            });

            fetchSharedLists();
        }

        async function renameList(listId, oldName) {
            const newName = prompt("Enter new name for the list:", oldName);
            if (!newName || newName === oldName) return; // ❌ Отмена, если имя не изменилось

            const token = localStorage.getItem("token");

            const response = await fetch(`/rename_list`, {
                method: 'PATCH',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ list_id: listId, new_name: newName })
            });

            if (response.ok) {
                alert("List renamed successfully!");
                fetchLists(); // ߔ䠐новляем списки
            } else {
                alert("Failed to rename list.");
            }
        }

        async function deleteList(listId) {
            if (!confirm("Are you sure you want to delete this list?")) return;

            const token = localStorage.getItem("token");

            const response = await fetch(`/delete_list`, {
                method: 'DELETE',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ list_id: listId })
            });

            if (response.ok) {
                alert("List deleted successfully!");
                fetchLists(); // ߔ䠐новляем списки
            } else {
                alert("Failed to delete list.");
            }
        }

        async function checkAuth() {
            const token = localStorage.getItem("token");

            if (!token) {
                document.getElementById('auth-section').style.display = 'block';
                document.getElementById('lists-section').style.display = 'none';
                return;
            }

            // Если токен есть → загружаем списки
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('lists-section').style.display = 'block';
            fetchLists();
        }

        // Проверяем сессию при загрузке страницы
        window.onload = checkAuth;

        let currentListId = null;

        function openList(listId, listName) {
            document.getElementById('lists-section').style.display = 'none';
            document.getElementById('items-section').style.display = 'block';
            document.getElementById('current-list-name').textContent = listName;
            currentListId = listId;            

            fetchItems(listId);
        }

    </script>
</body>
</html>
